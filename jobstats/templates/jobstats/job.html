{% extends 'base.html' %}
{% load humanize %}
{% load i18n %}

{% block title %}{% translate "Details on job" %} {{job_id}} {% endblock title %}

{% block content %}
<h1>{% translate "Details on job" %} {{job.job_name}} ({{job_id}})</h1>
<p><span class="badge badge-{{job.status_badge}}">{{job.status}}</span></p>
<div class="progress">
  {% if job.time_start != 0 and job.time_end == 0 %}
  <div class="progress-bar progress-bar-striped progress-bar-animated bg-{{job.status_badge}}" role="progressbar" aria-valuenow="{{job.wallclock_progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{job.wallclock_progress}}%"></div>
  {% else %}
  <div class="progress-bar bg-{{job.status_badge}}" role="progressbar" aria-valuenow="{{job.wallclock_progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{job.wallclock_progress}}%"></div>
  {% endif%}
</div>

{% if job_script %}
<p>
  <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_job_script" aria-expanded="false" aria-controls="collapse_job_script">
    {% translate "Show submited job script" %}
  </button>
</p>
<div class="collapse" id="collapse_job_script">
  <div class="card card-body">
    <pre>
{{job_script.submit_script}}
    </pre>
  </div>
</div>
{% else %}
<p>
  <button class="btn btn-secondary" type="button">
    {% translate "Submited job script is not available" %}
  </button>
</p>
{% endif %}

<h2>{% translate "Scheduler info" %}</h2>
<table class="table table-striped">
  <thead class="thead-dark">
    <tr>
      <th scope="col">{% translate "Account" %}</th>
      <th scope="col">{% translate "Submit time" %}</th>
      <th scope="col">{% translate "Time waiting in queue" %}</th>
      <th scope="col">{% translate "Start time" %}</th>
      <th scope="col">{% translate "End time" %}</th>
      <th scope="col">
        {% if job.time_start_dt %}
        <span data-toggle="tooltip" data-placement="top" title="{% translate "LevelFS at job start" %}">{% translate "Priority" %} <span data-feather="info"></span></span>
        {% else %}
        <span data-toggle="tooltip" data-placement="top" title="{% translate "Current LevelFS" %}">{% translate "Priority" %} <span data-feather="info"></span></span>
        {% endif %}
      </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        {% if 'accountstats' in settings.INSTALLED_APPS %}
          <a href="/secure/accountstats/{{ job.account }}">{{job.account}}</a>
        {% else %}
          {{job.account}}
        {% endif %}
      </td>
      <td><span data-toggle="tooltip" data-placement="top" title="{{job.time_submit_dt}}">{{job.time_submit_dt | naturaltime}} <span data-feather="info"></span></span></td>
      <td><span data-toggle="tooltip" data-placement="top" title="{{job.time_in_queue_dt}}">{{job.time_in_queue_dt | naturaltime}} <span data-feather="info"></span></span></td>
      <td><span data-toggle="tooltip" data-placement="top" title="{{job.time_start_dt}}">{{job.time_start_dt | default_if_none:'' | naturaltime}} <span data-feather="info"></span></span></td>
      <td><span data-toggle="tooltip" data-placement="top" title="{{job.time_end_dt}}">{{job.time_end_dt | default_if_none:'' | naturaltime}} <span data-feather="info"></span></span></td>
      <td>{{priority}}</td>
    </tr>
  </tbody>
</table>

<h2>{% translate "Resources" %}</h2>
<table class="table table-striped">
  <thead class="thead-dark">
    <tr>
      <th scope="col">{% translate "Type" %}</th>
      <th scope="col">{% translate "Allocated" %}</th>
      <th scope="col">{% translate "Used" %}</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>{% translate "Time" %}</td>
      <td>{{job.timelimit_display | default_if_none:'' }}</td>
      <td>{{job.used_time_display | default_if_none:'' }}</td>
    </tr>
    <tr>
      <td>{% translate "Nodes" %}</td>
      <td>{{tres_req.nb_nodes}}</td>
      <td></td>
    </tr>
    <tr>
      <td>{% translate "CPU cores" %}</td>
      <td>{{tres_req.total_cores}}</td>
      <td>{{cpu_used | floatformat:-2}}</td>
    </tr>
    <tr>
      <td>{% translate "Memory" %}</td>
      <td>{{total_mem | filesizeformat}} </td>
      <td>{{mem_used | filesizeformat}}</td>
    </tr>
{% if job.gpu_count > 0 %}
    <tr>
      <td>{% translate "GPUs per node" %}</td>
      <td>{{job.gpu_count}}x {{job.gpu_type}}</td>
      <td>{% translate "Cycles" %}: {{gpu_used | floatformat:-2 }}%, {% translate "Memory" %}: {{gpu_mem | floatformat:-2 }}%, {% translate "Power" %}: {{gpu_power | floatformat:-2 }}%</td>
    </tr>
{% endif %}

  {% if job.time_start_dt %}
    {% if 'redfish_exporter' in settings.EXPORTER_INSTALLED %}
      <tr>
        <td>{% translate "Energy" %}</td>
        <td></td>
        <td>
          <div id="energy">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </td>
      </tr>
      {% if settings.ELECTRICITY_COST_PER_KWH %}
        <tr>
          <td>{% translate "Electric car range equivalent" %}</td>
          <td></td>
          <td>
            <div id="car_range">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
              </div>
            </div>
          </td>
        </tr>
      {% endif %}
      {% if settings.CO2_KG_PER_MWH %}
        <tr>
          <td>{% translate "CO2 emissions" %}</td>
          <td></td>
          <td>
            <div id="co2">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
              </div>
            </div>
          </td>
        </tr>
      {% endif %}
      {% if settings.CPU_CORE_COST_PER_HOUR or settings.GPU_COST_PER_HOUR%}
        <tr>
          <td>{% translate "Internal cost" %}</td>
          <td></td>
          <td>
            <div id="cost">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
              </div>
            </div>
          </td>
        </tr>
      {% endif %}
    {% endif %}
    {% if settings.CLOUD_CPU_CORE_COST_PER_HOUR and settings.CLOUD_GPU_COST_PER_HOUR %}
      <tr>
        <td>{% translate "Cloud cost equivalent" %}</td>
        <td></td>
        <td>
          <div id="cloud">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </td>
      </tr>
    {% endif %}
  {% endif %}
  </tbody>
</table>

{% if job.time_start_dt %}
  <h2>{% translate "Resources used (details)" %}</h2>
  <h3>{% translate "CPU" %}</h3>
  <div id="graph_cpu"></div>
  <h3>{% translate "Memory" %}</h3>
  <div id="graph_mem"></div>
  <h3>{% translate "Filesystem" %}</h3>
  <div id="graph_lustre_mdt"></div>
  <div id="graph_lustre_ost"></div>

  {% if job.gpu_count > 0 %}
    <h3>{% translate "GPU" %}</h3>
    <h4>{% translate "GPU Compute cycle used" %}</h4>
    <div id="graph_gpu_utilization"></div>
    <h4>{% translate "GPU Memory access cycle used" %}</h4>
    <div id="graph_gpu_memory_utilization"></div>
    <h4>{% translate "GPU Memory used" %}</h4>
    <div id="graph_gpu_memory"></div>
    <h4>{% translate "GPU Power" %}</h4>
    <div id="graph_gpu_power"></div>
    <h4>{% translate "GPU PCIe bandwidth" %}</h4>
    <div id="graph_gpu_pcie"></div>
  {% endif %}

  {% if 'node_exporter' in settings.EXPORTER_INSTALLED %}
    <h2>{% translate "Whole node resources" %}</h2>
    <p>{% translate "Those stats are not accurate when the node is shared with multiple users" %}</p>
    <h3>{% translate "Infiniband" %}</h3>
    <div id="graph_infiniband_bdw"></div>
    <h3>{% translate "Localscratch IOPS" %}</h3>
    <div id="graph_disk_iops"></div>
    <h3>{% translate "Localscratch bandwidth" %}</h3>
    <div id="graph_disk_bdw"></div>
    <h3>{% translate "Localscratch space used" %}</h3>
    <div id="graph_disk_used"></div>
    {% if 'redfish_exporter' in settings.EXPORTER_INSTALLED %}
      <h3>{% translate "Power used" %}</h3>
      <div id="graph_power"></div>
    {% endif %}
  {% endif %}

  <script>
  loadGraph('graph_cpu', 'graph/cpu.json?step={{step}}');
  loadGraph('graph_mem', 'graph/mem.json?step={{step}}');
  loadGraph('graph_lustre_mdt', 'graph/lustre_mdt.json?step={{step}}');
  loadGraph('graph_lustre_ost', 'graph/lustre_ost.json?step={{step}}');

  {% if job.gpu_count > 0 %}
    loadGraph('graph_gpu_utilization', 'graph/gpu_utilization.json?step={{step}}');
    loadGraph('graph_gpu_memory_utilization', 'graph/gpu_memory_utilization.json?step={{step}}');
    loadGraph('graph_gpu_memory', 'graph/gpu_memory.json?step={{step}}');
    loadGraph('graph_gpu_power', 'graph/gpu_power.json?step={{step}}');
    loadGraph('graph_gpu_pcie', 'graph/gpu_pcie.json?step={{step}}');
  {% endif %}
  {% if 'node_exporter' in settings.EXPORTER_INSTALLED %}
    loadGraph('graph_infiniband_bdw', 'graph/infiniband_bdw.json?step={{step}}');
    loadGraph('graph_disk_iops', 'graph/disk_iops.json?step={{step}}');
    loadGraph('graph_disk_bdw', 'graph/disk_bdw.json?step={{step}}');
    loadGraph('graph_disk_used', 'graph/disk_used.json?step={{step}}');
  {% endif %}

  {% if 'redfish_exporter' in settings.EXPORTER_INSTALLED %}
    loadGraph('graph_power', 'graph/power.json?step={{step}}');
  {% endif %}

  const formatter = new Intl.NumberFormat('en-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  $.ajax({
    url : 'value/cost.json',
    type : 'GET',
    tryCount : 0,
    retryLimit : 3,
    dataType    : 'json',
    contentType : 'application/json',
    success : function(data) {
      if(data.kwh) {
        $('#energy').html(formatter.format(data.kwh) + ' kWh');
      }

      if(data.electric_car_range_km){
        $('#car_range').html('<a href="#" data-toggle="tooltip" title=Based on the efficiency of a Tesla Model 3">' + formatter.format(data.electric_car_range_km) + ' km </a>');
      }

      if(data.co2_emissions_kg) {
        $('#co2').html(formatter.format(data.co2_emissions_kg * 1000) + ' g');
      }

      if(data.electricity_cost_dollar && data.cooling_cost_dollar && data.hardware_cost_dollar){
        $('#cost').html('Electricity: ' + formatter.format(data.electricity_cost_dollar)
        + ' $ <br /> Cooling: ' + formatter.format(data.cooling_cost_dollar)
        + ' $ <br /> <a href="#" data-toggle="tooltip" title="Amortized over {{settings.AMORTIZATION_YEARS}} years">Hardware:</a> ' + formatter.format(data.hardware_cost_dollar)
        + ' $ <br /> Total: ' + formatter.format(data.electricity_cost_dollar + data.cooling_cost_dollar + data.hardware_cost_dollar) + ' $');
      }

      if(data.cloud_cost_dollar){
        $('#cloud').html('<a href="#" data-toggle="tooltip" title="Based on the price of c6a.16xlarge and g5.12xlarge">On-Demand instance:</a> ' +formatter.format(data.cloud_cost_dollar) + ' $');
      }
      $('[data-toggle="tooltip"]').tooltip();
    },
    error : function(xhr, textStatus, errorThrown ) {
      if (textStatus == 'timeout' || textStatus == 'error') {
        this.tryCount++;
        if (this.tryCount <= this.retryLimit) {
            //try again
            $.ajax(this);
            return;
        }
      }
      $('#energy').html('No data');
      $('#car_range').html('No data');
      $('#co2').html('No data');
      $('#cost').html('No data');
      $('#cloud').html('No data');
    }
  });

  </script>
{% endif %}
{% endblock content %}
